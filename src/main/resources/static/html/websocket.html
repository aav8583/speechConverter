<!DOCTYPE html>
<html>
<head>
    <title>Speech Recognition with Websockets</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
</head>
<body>
<h1>Speech Recognition with Websockets</h1>
<div>
<label for="recognition-lang">Recognition Language:</label>
<select id="recognition-lang">
    <option value="en-EN">English</option>
    <option value="ru-RU">Russian</option>
    <option value="sr-SR">Serbian</option>
</select>

<label for="translated-lang">Translated Language:</label>
<select id="translated-lang">
    <option value="en-EN">English</option>
    <option value="ru-RU">Russian</option>
    <option value="sr-SR">Serbian</option>
</select>
</div>
<button id="start-recording-btn">Start record</button>
<button id="stop-recording-btn" disabled>Stop record</button>
<script>
    var stompClient = null;
    var recognizedText = ''; // Текст, распознанный за текущий интервал
    var buffer = ''; // Буфер для накопления текста до отправки
    var sendIntervalId = null; // ID интервала для отправки текста

    function connect() {
        var socket = new SockJS('/speech-websocket');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function(frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/speechresults', function(messageOutput) {
                var translatedText = messageOutput.body;
                speakText(translatedText);
            });
        });
    }

    var recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.continuous = true;
    recognition.interimResults = false;

    recognition.onresult = function(event) {
        if (event.results[event.results.length - 1].isFinal) {
            var text = event.results[event.results.length - 1][0].transcript;
            recognizedText += text;
            buffer += recognizedText;
        }
    };

    recognition.onend = function() {
        // Отправка текста при остановке распознавания
        sendText();
        // Перезапуск распознавания с задержкой в 100 миллисекунд
        setTimeout(function() {
            if (!document.getElementById('stop-recording-btn').disabled) {
                recognition.start();
            }
        }, 1);
    };

    function sendText() {
        if (buffer.length > 0) {
            // Чтение выбранного языка синтеза речи
            var selectedTranslatedLang = document.getElementById('translated-lang').value;

            // Создание объекта с текстом и языком
            var messageData = {
                text: buffer,
                recognitionLang: recognition.lang,
                translatedLang: selectedTranslatedLang
            };

            // Преобразование объекта в строку JSON для отправки
            var messageDataString = JSON.stringify(messageData);

            stompClient.send("/app/speech", {}, messageDataString);
            recognizedText = ''; // Очистка распознанного текста после отправки
            buffer = ''; // Очистка буфера после отправки
        }
    }

    document.getElementById('start-recording-btn').addEventListener('click', function() {
        // Чтение и установка выбранного языка распознавания
        var selectedRecognitionLang = document.getElementById('recognition-lang').value;
        recognition.lang = selectedRecognitionLang;
        recognition.start();
        document.getElementById('start-recording-btn').disabled = true;
        document.getElementById('stop-recording-btn').disabled = false;
        // Устанавливаем интервал для остановки и перезапуска распознавания
        sendIntervalId = setInterval(function() {
            recognition.stop(); // Остановка вызовет срабатывание onend и отправку текста
        }, 5000);
    });

    document.getElementById('stop-recording-btn').addEventListener('click', function() {
        clearInterval(sendIntervalId); // Очищаем интервал, чтобы он не вызывал stop после нажатия кнопки
        recognition.stop();
        document.getElementById('start-recording-btn').disabled = false;
        document.getElementById('stop-recording-btn').disabled = true;
    });

    // Функция для воспроизведения текста
    function speakText(text) {
        var utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 1.8;
        utterance.pitch = 1.9;
        speechSynthesis.speak(utterance);
    }

    connect();
</script>
</body>
</html>